define("tiny_cursive/autosaver",["exports","core/ajax","core/modal_factory","core/str","core/modal_events","jquery","tiny_cursive/user"],(function(_exports,_ajax,_modal_factory,_str,_modal_events,_jquery,_user){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.register=void 0,_jquery=_interopRequireDefault(_jquery),_user=_interopRequireDefault(_user);_exports.register=(editor,interval)=>{var is_student=!(0,_jquery.default)("#body").hasClass("teacher_admin"),intervention=(0,_jquery.default)("#body").hasClass("intervention"),userid=null,host=null,courseid=null,filename="",quizSubmit=(0,_jquery.default)("#mod_quiz-next-nav"),ed="",event="",recourceId=0,modulename="",editorid=null==editor?void 0:editor.id;var classes=(0,_jquery.default)("body").attr("class").split(" "),cmid=0,questionid=0;let assignSubmit=(0,_jquery.default)("#id_submitbutton");var syncInterval=interval?1e3*interval:1e4;const postOne=async(methodname,args)=>{try{return await(0,_ajax.call)([{methodname:methodname,args:args}])[0]}catch(error){throw window.console.error("Error in postOne:",error),error}};assignSubmit.on("click",(async function(e){e.preventDefault(),filename?SyncData().then((()=>{assignSubmit.off("click").click()})):assignSubmit.off("click").click()})),quizSubmit.on("click",(async function(e){e.preventDefault(),filename?SyncData().then((()=>{quizSubmit.off("click").click()})):quizSubmit.off("click").click()}));const getModal=e=>(0,_modal_factory.create)({type:"SAVE_CANCEL",title:(0,_str.get_string)("tiny_cursive","tiny_cursive"),body:'<textarea  class="form-control inputUrl" value="" id="inputUrl" placeholder="sourceurl"></textarea>',removeOnClose:!0}).done((modal=>{modal.getRoot().append("<style>.close{ display: none ! important; }</style>"),modal.show();var lastEvent="";return modal.getRoot().on(_modal_events.save,(function(){var number=document.getElementById("inputUrl").value;""===number||null==number?(editor.execCommand("Undo"),alert("You cannot paste text without providing source")):editor.execCommand("Paste");let ur=e.srcElement.baseURI,recourceId=0,parm=new URL(ur),modulename="",editorid=null==editor?void 0:editor.id,classes=(0,_jquery.default)("body").attr("class").split(" "),courseid=parseInt(classes.find((classname=>classname.startsWith("course-"))).split("-")[1]),cmid=parseInt(classes.find((classname=>classname.startsWith("cmid-"))).split("-")[1]);if(!(ur.includes("attempt.php")||ur.includes("forum")||ur.includes("assign")))return!1;ur.includes("forum")||ur.includes("assign")||(recourceId=parm.searchParams.get("attempt")),null===recourceId&&(recourceId=0),ur.includes("forum")&&(modulename="forum"),ur.includes("assign")&&(modulename="assign"),ur.includes("attempt")&&(modulename="quiz"),null===cmid&&(cmid=0),postOne("cursive_user_comments",{modulename:modulename,cmid:cmid,resourceid:recourceId,courseid:courseid,usercomment:number,timemodified:Date.now(),editorid:editorid||""}),lastEvent="save",modal.destroy()})),modal.getRoot().on(_modal_events.cancel,(function(){editor.execCommand("Undo"),lastEvent="cancel"})),modal.getRoot().on(_modal_events.hidden,(function(){"cancel"!=lastEvent&&"save"!=lastEvent&&editor.execCommand("Undo")})),modal})),sendKeyEvent=(events,eds)=>{let ur=eds.srcElement.baseURI,parm=new URL(ur);ed=eds,event=events;let bodyid=(0,_jquery.default)("body").attr("id");if("page-mod-quiz-attempt"!=bodyid&&"page-mod-quiz-summary"!=bodyid&&"page-mod-assign-editsubmission"!=bodyid&&"page-mod-forum-view"!=bodyid&&"page-mod-forum-post"!=bodyid||(cmid=parseInt(classes.find((classname=>classname.startsWith("cmid-"))).split("-")[1])),!(ur.includes("attempt.php")||ur.includes("forum")||ur.includes("assign")))return!1;if(ur.includes("forum")||ur.includes("assign")||(recourceId=parm.searchParams.get("attempt")),null===recourceId&&(recourceId=0),ur.includes("forum")&&(modulename="forum"),ur.includes("assign")&&(modulename="assign"),ur.includes("attempt")&&(modulename="quiz"),filename="".concat(userid,"_").concat(recourceId,"_").concat(cmid,"_").concat(modulename,"_attempt"),"quiz"===modulename&&(questionid=editorid.split(":")[1].split("_")[0],filename="".concat(userid,"_").concat(recourceId,"_").concat(cmid,"_").concat(questionid,"_").concat(modulename,"_attempt")),localStorage.getItem(filename)){let data=JSON.parse(localStorage.getItem(filename));data.push({resourceId:recourceId,key:ed.key,keyCode:ed.keyCode,event:event,courseId:courseid,unixTimestamp:Date.now(),clientId:host,personId:userid}),localStorage.setItem(filename,JSON.stringify(data))}else{let data=[];data.push({resourceId:recourceId,key:ed.key,keyCode:ed.keyCode,event:event,courseId:courseid,unixTimestamp:Date.now(),clientId:host,personId:userid}),localStorage.setItem(filename,JSON.stringify(data))}};async function SyncData(){let data=localStorage.getItem(filename);if(data&&0!==data.length){localStorage.removeItem(filename);try{return await postOne("cursive_write_local_to_json",{key:ed.key,event:event,keyCode:ed.keyCode,resourceId:recourceId,cmid:cmid,modulename:modulename,editorid:editorid,json_data:data})}catch(error){window.console.error("Error submitting data:",error)}}}editor.on("keyUp",(editor=>{sendKeyEvent("keyUp",editor)})),editor.on("Paste",(async e=>{is_student&&intervention&&getModal(e)})),editor.on("Redo",(async e=>{is_student&&intervention&&getModal(e)})),editor.on("keyDown",(editor=>{sendKeyEvent("keyDown",editor)})),editor.on("init",(()=>{let userdata=_user.default.getUserId();userid=userdata.userid,host=userdata.host,courseid=userdata.courseid})),window.addEventListener("unload",(()=>{SyncData()})),setInterval(SyncData,syncInterval)}}));

//# sourceMappingURL=autosaver.min.js.map