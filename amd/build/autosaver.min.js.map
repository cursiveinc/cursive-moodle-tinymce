{"version":3,"file":"autosaver.min.js","sources":["../src/autosaver.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     tiny_cursive/autosaver\n * @category TinyMCE Editor\n * @copyright  CTI <info@cursivetechnology.com>\n * @author kuldeep singh <mca.kuldeep.sekhon@gmail.com>\n */\n\nimport {call} from 'core/ajax';\nimport {create} from 'core/modal_factory';\nimport {get_string as getString} from 'core/str';\nimport {save, cancel, hidden} from 'core/modal_events';\nimport jQuery from 'jquery';\nimport user from 'tiny_cursive/user';\n\nexport const register = (editor, interval) => {\n\n    var isStudent = !(jQuery('#body').hasClass('teacher_admin'));\n    var intervention = jQuery('#body').hasClass('intervention');\n    var userid = null;\n    var host = null;\n    var courseid = null;\n    var filename = \"\";\n    var quizSubmit = jQuery('#mod_quiz-next-nav');\n    var ed = \"\";\n    var event = \"\";\n    var recourceId = 0;\n    var modulename = \"\";\n    var editorid = editor?.id;\n    let bodyid = jQuery('body').attr('class');\n    var classes = bodyid.split(' ');\n    var cmid = 0;\n    var questionid = 0;\n    let assignSubmit = jQuery('#id_submitbutton');\n    var syncInterval = interval ? interval * 1000 : 10000; // Default: Sync Every 10s.\n\n    const postOne = async(methodname, args) => {\n        try {\n            const response = await call([{\n                methodname,\n                args,\n            }])[0];\n            return response;\n        } catch (error) {\n            window.console.error('Error in postOne:', error);\n            throw error;\n        }\n    };\n\n    assignSubmit.on('click', async function(e) {\n        e.preventDefault();\n        if (filename) {\n            // eslint-disable-next-line\n            syncData().then(() => {\n                assignSubmit.off('click').click();\n            });\n        } else {\n            assignSubmit.off('click').click();\n        }\n    });\n\n    quizSubmit.on('click', async function(e) {\n        e.preventDefault();\n        if (filename) {\n            // eslint-disable-next-line\n            syncData().then(() => {\n                quizSubmit.off('click').click();\n            });\n        } else {\n            quizSubmit.off('click').click();\n        }\n    });\n\n    const getModal = (e) => {\n        return create({\n            type: 'SAVE_CANCEL',\n            title: getString('tiny_cursive', 'tiny_cursive'),\n            body: '<textarea  class=\"form-control inputUrl\" value=\"\" id=\"inputUrl\" placeholder=\"sourceurl\"></textarea>',\n\n            removeOnClose: true,\n        })\n            .done(modal => {\n                modal.getRoot().append('<style>.close{ display: none ! important; }</style>');\n                modal.show();\n                var lastEvent = '';\n                // eslint-disable-next-line\n                modal.getRoot().on(save, function() {\n                    var number = document.getElementById(\"inputUrl\").value;\n                    if (number === \"\" || number === null || number === undefined) {\n                        editor.execCommand('Undo');\n                        // eslint-disable-next-line\n                        alert(\"You cannot paste text without providing source\");\n                    } else {\n                        editor.execCommand('Paste');\n                    }\n                    let ur = e.srcElement.baseURI;\n                    let recourceId = 0;\n                    let parm = new URL(ur);\n                    let modulename = \"\";\n                    let editorid = editor?.id;\n                    let bodyid = jQuery('body').attr('class');\n                    let classes = bodyid.split(' ');\n                    let courseid = parseInt(classes.find((classname) => {\n                        return classname.startsWith('course-');\n                    }).split('-')[1]); // Getting cmid from body classlist.\n                    let cmid = parseInt(classes.find((classname) => {\n                        return classname.startsWith('cmid-');\n                    }).split('-')[1]); // Getting cmid from body classlist.\n\n                    // eslint-disable-next-line\n                    if (ur.includes(\"attempt.php\") || ur.includes(\"forum\") || ur.includes(\"assign\")) { } else {\n                        return false;\n                    }\n\n                    if (!ur.includes(\"forum\") && !ur.includes(\"assign\")) {\n                        recourceId = parm.searchParams.get('attempt');\n                    }\n\n                    if (recourceId === null) {\n                        recourceId = 0;\n                    }\n                    if (ur.includes(\"forum\")) {\n                        modulename = \"forum\";\n                    }\n                    if (ur.includes(\"assign\")) {\n                        modulename = \"assign\";\n                    }\n                    if (ur.includes(\"attempt\")) {\n                        modulename = \"quiz\";\n                    }\n                    if (cmid === null) {\n                        cmid = 0;\n                    }\n\n                    postOne('cursive_user_comments', {\n                        modulename: modulename,\n                        cmid: cmid,\n                        resourceid: recourceId,\n                        courseid: courseid,\n                        usercomment: number,\n                        timemodified: Date.now(),\n                        editorid: editorid ? editorid : \"\"\n                    });\n                    lastEvent = 'save';\n                    modal.destroy();\n                });\n                modal.getRoot().on(cancel, function() {\n\n                    editor.execCommand('Undo');\n                    lastEvent = 'cancel';\n                });\n                modal.getRoot().on(hidden, function() {\n                    if (lastEvent != 'cancel' && lastEvent != 'save') {\n                        editor.execCommand('Undo');\n                    }\n                });\n                return modal;\n            });\n    };\n    // eslint-disable-next-line\n    const sendKeyEvent = (events, eds) => {\n        let ur = eds.srcElement.baseURI;\n        let parm = new URL(ur);\n        ed = eds;\n        event = events;\n        let bodyid = jQuery('body').attr('id');\n\n        if (bodyid == 'page-mod-quiz-attempt' || bodyid == 'page-mod-quiz-summary' ||\n            bodyid == 'page-mod-assign-editsubmission' || bodyid == 'page-mod-forum-view' ||\n            bodyid == 'page-mod-forum-post') {\n            cmid = parseInt(classes.find((classname) => {\n                return classname.startsWith('cmid-');\n            }).split('-')[1]); // Getting cmid from body classlist.\n        }\n        // eslint-disable-next-line\n        if (ur.includes(\"attempt.php\") || ur.includes(\"forum\") || ur.includes(\"assign\")) { } else {\n            return false;\n        }\n        // eslint-disable-next-line\n        if (ur.includes(\"forum\") || ur.includes(\"assign\")) {\n        } else {\n\n            recourceId = parm.searchParams.get('attempt');\n        }\n        if (recourceId === null) {\n\n            recourceId = 0;\n        }\n\n        if (ur.includes(\"forum\")) {\n            modulename = \"forum\";\n        }\n        if (ur.includes(\"assign\")) {\n            modulename = \"assign\";\n        }\n        if (ur.includes(\"attempt\")) {\n            modulename = \"quiz\";\n        }\n\n        filename = `${userid}_${recourceId}_${cmid}_${modulename}_attempt`;\n\n        if (modulename === 'quiz') {\n            questionid = editorid.split(':')[1].split('_')[0];\n            filename = `${userid}_${recourceId}_${cmid}_${questionid}_${modulename}_attempt`;\n\n        }\n\n        if (localStorage.getItem(filename)) {\n\n            let data = JSON.parse(localStorage.getItem(filename));\n            data.push({\n                resourceId: recourceId,\n                key: ed.key,\n                keyCode: ed.keyCode,\n                event: event,\n                courseId: courseid,\n                unixTimestamp: Date.now(),\n                clientId: host,\n                personId: userid\n            });\n            localStorage.setItem(filename, JSON.stringify(data));\n        } else {\n            let data = [];\n            data.push({\n                resourceId: recourceId,\n                key: ed.key,\n                keyCode: ed.keyCode,\n                event: event,\n                courseId: courseid,\n                unixTimestamp: Date.now(),\n                clientId: host,\n                personId: userid\n            });\n            localStorage.setItem(filename, JSON.stringify(data));\n        }\n\n    };\n    editor.on('keyUp', (editor) => {\n        sendKeyEvent(\"keyUp\", editor);\n    });\n    editor.on('Paste', async(e) => {\n        if (isStudent && intervention) {\n            getModal(e);\n        }\n    });\n    editor.on('Redo', async(e) => {\n        if (isStudent && intervention) {\n            getModal(e);\n        }\n    });\n    editor.on('keyDown', (editor) => {\n        sendKeyEvent(\"keyDown\", editor);\n    });\n    editor.on('init', () => {\n        let userdata = user.getUserId();\n        userid = userdata.userid;\n        host = userdata.host;\n        courseid = userdata.courseid;\n    });\n\n    /**\n     * Synchronizes data from localStorage to server\n     * @async\n     * @function SyncData\n     * @description Retrieves stored keypress data from localStorage and sends it to server\n     * @returns {Promise} Returns response from server if data exists and is successfully sent\n     * @throws {Error} Logs error to console if data submission fails\n     */\n    async function syncData() {\n\n        let data = localStorage.getItem(filename);\n\n        if (!data || data.length === 0) {\n            return;\n        } else {\n            localStorage.removeItem(filename);\n            try {\n                // eslint-disable-next-line\n                return await postOne('cursive_write_local_to_json', {\n                    key: ed.key,\n                    event: event,\n                    keyCode: ed.keyCode,\n                    resourceId: recourceId,\n                    cmid: cmid,\n                    modulename: modulename,\n                    editorid: editorid,\n                    \"json_data\": data,\n                });\n            } catch (error) {\n                window.console.error('Error submitting data:', error);\n            }\n        }\n    }\n\n    window.addEventListener('unload', () => {\n        syncData();\n    });\n\n    setInterval(syncData, syncInterval);\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","_jquery","_user","_exports","register","editor","interval","isStudent","jQuery","hasClass","intervention","userid","host","courseid","filename","quizSubmit","ed","event","recourceId","modulename","editorid","id","classes","attr","split","cmid","questionid","assignSubmit","syncInterval","postOne","async","methodname","args","call","error","window","console","on","e","preventDefault","syncData","then","off","click","getModal","create","type","title","getString","body","removeOnClose","done","modal","getRoot","append","show","lastEvent","save","number","document","getElementById","value","execCommand","alert","ur","srcElement","baseURI","parm","URL","parseInt","find","classname","startsWith","includes","searchParams","get","resourceid","usercomment","timemodified","Date","now","destroy","cancel","hidden","sendKeyEvent","events","eds","bodyid","concat","localStorage","getItem","data","JSON","parse","push","resourceId","key","keyCode","courseId","unixTimestamp","clientId","personId","setItem","stringify","length","removeItem","json_data","userdata","user","getUserId","addEventListener","setInterval"],"mappings":"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"}